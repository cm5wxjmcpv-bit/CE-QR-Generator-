<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CE QR Generator – Admin View</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #fff; margin: 20px; }
  h1 { text-align: center; }
  button { margin: 5px; padding: 8px 16px; cursor: pointer; }
  .entry { border-bottom: 1px solid #ccc; padding: 10px 0; }
  .hidden { display: none; }
  img { display: block; margin-top: 5px; }
</style>
</head>
<body>
  <h1>CE QR Generator – Admin View</h1>
  <div id="login">
    <p>Enter Password:</p>
    <input type="password" id="pw" />
    <button onclick="checkPW()">Login</button>
    <p id="loginMsg" style="color:red;"></p>
  </div>

  <div id="admin" class="hidden">
    <button onclick="exportPDF()">Export All to PDF</button>
    <button onclick="deleteAll()">Delete All</button>
    <button onclick="logout()">Logout</button>
    <div id="records"></div>
  </div>

  <script>
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbz4fAjnjqfybEBRVnFhQcnAnlOfyRUlYP5f34yZMUjaaSsBwRzPmaK6tfWFsB4kha-6/exec";
  const realPW = "Firefighter522539";

  function checkPW() {
    const p = document.getElementById('pw').value.trim();
    if (p === realPW) {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('admin').classList.remove('hidden');
      loadRecords();
    } else {
      document.getElementById('loginMsg').innerText = "Incorrect password.";
    }
  }

  async function loadRecords() {
    try {
      const res = await fetch(SHEET_URL);
      const recs = await res.json();
      const div = document.getElementById('records');
      div.innerHTML = '';
      if (!recs.length) {
        div.innerHTML = "<p>No records found.</p>";
        return;
      }
      recs.forEach(r => {
        const e = document.createElement('div');
        e.className = 'entry';
        e.innerHTML = `<p><strong>${r.codeText}</strong><br>${r.timestamp}</p>`;
        if (r.image) {
          const img = new Image();
          img.src = r.image;
          img.width = 150;
          e.appendChild(img);
        }
        div.appendChild(e);
      });
    } catch (err) {
      console.error("Error fetching sheet data:", err);
      document.getElementById('records').innerHTML = "<p>Error loading data.</p>";
    }
  }

  function deleteAll() {
    if (confirm("Are you sure you want to delete all records?")) {
      // Clearing sheet from client side isn't possible via script.
      alert("You must clear data manually in the Google Sheet for now.");
    }
  }

  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    doc.setFontSize(14);
    doc.text("CE QR Generator Records", 10, 10);
    document.querySelectorAll(".entry").forEach(e => {
      const textEl = e.querySelector("p strong");
      const tsEl = e.querySelector("p");
      const imgEl = e.querySelector("img");
      if (textEl) {
        const txt = textEl.innerText;
        doc.text(txt, 10, y);
        y += 10;
      }
      if (tsEl) {
        const time = tsEl.innerText;
        doc.text(time, 10, y);
        y += 10;
      }
      if (imgEl) {
        doc.addImage(imgEl.src, "PNG", 10, y, 40, 40);
        y += 50;
      }
      if (y > 260) {
        doc.addPage();
        y = 20;
      }
    });
    doc.save("QR_Records.pdf");
  }

  function logout() {
    document.getElementById('admin').classList.add('hidden');
    document.getElementById('login').classList.remove('hidden');
    document.getElementById('pw').value = '';
  }
  </script>
</body>
</html>
