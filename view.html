<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MFD CE Records â€“ Admin</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="admin-body">
  <div class="admin-container">
    <h1>Martinsville Fire & EMS<br>Admin Record View</h1>

    <div id="login">
      <p>Enter Password:</p>
      <input type="password" id="pw" />
      <button onclick="checkPW()">Login</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>

    <div id="admin" class="hidden">
      <button onclick="exportPDF()">Export All to PDF</button>
      <button onclick="logout()">Logout</button>
      <div id="records"></div>
    </div>
  </div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbz4fAjnjqfybEBRVnFhQcnAnlOfyRUlYP5f34yZMUjaaSsBwRzPmaK6tfWFsB4kha-6/exec";
const realPW = "Firefighter522539";

function checkPW() {
  const p = document.getElementById('pw').value.trim();
  if (p === realPW) {
    document.getElementById('login').classList.add('hidden');
    document.getElementById('admin').classList.remove('hidden');
    loadRecords();
  } else {
    document.getElementById('loginMsg').innerText = "Incorrect password.";
  }
}

async function loadRecords() {
  const div = document.getElementById('records');
  div.innerHTML = "<p>Loading records...</p>";
  try {
    const res = await fetch(SHEET_URL);
    const recs = await res.json();

    // Group records by date
    const grouped = {};
    recs.forEach(r => {
      const day = new Date(r.timestamp).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      if (!grouped[day]) grouped[day] = [];
      grouped[day].push(r);
    });

    const sortedDays = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
    div.innerHTML = "";
    sortedDays.forEach(day => {
      const section = document.createElement('div');
      section.className = "day-group";
      section.innerHTML = `<h2 class="day-header">${day} (${grouped[day].length} entries)</h2>`;
      const list = document.createElement('div');
      list.className = "entry-list hidden";
      grouped[day].forEach(r => {
        const e = document.createElement('div');
        e.className = "entry";
        e.innerHTML = `<p><strong>${r.codeText}</strong><br>${new Date(r.timestamp).toLocaleTimeString()}</p>`;
        if (r.image) {
          const img = new Image();
          img.src = r.image;
          img.width = 100;
          e.appendChild(img);
        }
        list.appendChild(e);
      });
      section.appendChild(list);
      section.querySelector(".day-header").onclick = () => list.classList.toggle("hidden");
      div.appendChild(section);
    });

  } catch (err) {
    div.innerHTML = "<p>Error loading data.</p>";
  }
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;
  doc.setFontSize(14);
  doc.text("Martinsville Fire & EMS CE Records", 10, 10);

  document.querySelectorAll(".entry").forEach(e => {
    const txt = e.querySelector("strong")?.innerText || "";
    const ts = e.querySelector("p")?.innerText || "";
    const img = e.querySelector("img");
    doc.text(txt, 10, y); y += 8;
    doc.text(ts, 10, y); y += 8;
    if (img) { doc.addImage(img.src, "PNG", 10, y, 30, 30); y += 35; }
    if (y > 270) { doc.addPage(); y = 20; }
  });
  doc.save("MFD_CE_Records.pdf");
}

function logout() {
  document.getElementById('admin').classList.add('hidden');
  document.getElementById('login').classList.remove('hidden');
  document.getElementById('pw').value = '';
}
</script>
</body>
</html>
